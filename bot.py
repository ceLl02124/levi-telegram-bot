import asyncio
import logging
import os
import random
from datetime import datetime, timedelta
from aiogram import Bot, Dispatcher, F
from aiogram.types import Message
from aiogram.filters import Command
from keep_alive import keep_alive
import re

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# –¢–æ–∫–µ–Ω –±–æ—Ç–∞
BOT_TOKEN = os.getenv('BOT_TOKEN')
if not BOT_TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_context = {}

# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
MOOD_KEYWORDS = {
    '–≥—Ä—É—Å—Ç–Ω—ã–µ': ['–≥—Ä—É—Å—Ç–Ω–æ', '–ø–µ—á–∞–ª—å–Ω–æ', '–ø–ª–æ—Ö–æ', '–¥–µ–ø—Ä–µ—Å—Å–∏—è', '—É—Å—Ç–∞–ª', '—Ç—è–∂–µ–ª–æ', '–±–æ–ª—å–Ω–æ', '–æ–¥–∏–Ω–æ–∫–æ'],
    '–∑–ª—ã–µ': ['–∑–ª–æ–π', '–±–µ—Å–∏—Ç', '—Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç', '–Ω–µ–Ω–∞–≤–∏–∂—É', '–¥—É—Ä–∞–∫', '–∏–¥–∏–æ—Ç', '–¥–æ—Å—Ç–∞–ª'],
    '–≤–µ—Å–µ–ª—ã–µ': ['—Ö–æ—Ä–æ—à–æ', '–æ—Ç–ª–∏—á–Ω–æ', '–∫—Ä—É—Ç–æ', '–≤–µ—Å–µ–ª–æ', '—Å–º–µ—à–Ω–æ', '—Ö–∞-—Ö–∞', '–ª–æ–ª'],
    '–≤–æ–ø—Ä–æ—Å—ã': ['–∫–∞–∫', '—á—Ç–æ', '–≥–¥–µ', '–∫–æ–≥–¥–∞', '–ø–æ—á–µ–º—É', '–∑–∞—á–µ–º', '?'],
    '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ': ['–ø—Ä–∏–≤–µ—Ç', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π', '—Ö–∞–π', '–¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å', '—Å–∞–ª—é—Ç'],
    '–ø—Ä–æ—â–∞–Ω–∏–µ': ['–ø–æ–∫–∞', '–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è', '—É–≤–∏–¥–∏–º—Å—è', '–±–∞–π']
}

# –†–µ–ø–ª–∏–∫–∏ –õ–µ–≤–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π
LEVI_RESPONSES = {
    '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ': [
        "*—Ö–æ–ª–æ–¥–Ω–æ –∫–∏–≤–∞–µ—Ç* –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é... *—Ö–º—É—Ä–∏—Ç—Å—è* –ù–µ —Ç—Ä–∞—Ç—å –≤—Ä–µ–º—è –Ω–∞ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–∏. –õ—É—á—à–µ —Å–∫–∞–∂–∏, —á—Ç–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ.",
        "*—Å–º–æ—Ç—Ä–∏—Ç —Å–µ—Ä—å–µ–∑–Ω–æ* –¢–∏—à–∏–Ω–∞... *—Å–∫—Ä–µ—â–∏–≤–∞–µ—Ç —Ä—É–∫–∏* –ß—Ç–æ –ø—Ä–∏–≤–µ–ª–æ —Ç–µ–±—è —Å—é–¥–∞?",
        "*–ø–æ–¥–Ω–∏–º–∞–µ—Ç –≤–∑–≥–ª—è–¥ –æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤* –ú? *–æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç –±—É–º–∞–≥–∏* –ì–æ–≤–æ—Ä–∏ –ø–æ –¥–µ–ª—É."
    ],
    '–≥—Ä—É—Å—Ç—å': [
        "*–∑–∞–¥—É–º—á–∏–≤–æ —Å–º–æ—Ç—Ä–∏—Ç –≤ –æ–∫–Ω–æ* –ó–Ω–∞–µ—à—å... *–ø–∞—É–∑–∞* –í —ç—Ç–æ–º –º–∏—Ä–µ –∫–∞–∂–¥—ã–π –Ω–µ—Å–µ—Ç —Å–≤–æ—é –±–æ–ª—å. *–ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è* –ù–æ —Å–¥–∞–≤–∞—Ç—å—Å—è –Ω–µ–ª—å–∑—è. –ú—ã –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ, —Ä–∞–¥–∏ —Ç–µ—Ö, –∫–æ–≥–æ —É–∂–µ –Ω–µ—Ç —Å –Ω–∞–º–∏.",
        "*–º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–¥–Ω–∏–º–∞–µ—Ç –≤–∑–≥–ª—è–¥* –¢–∏—à–∏–Ω–∞... –ó–Ω–∞–µ—à—å, –≤ —Ç–∞–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã —è –¥—É–º–∞—é –æ —Ç–µ—Ö, –∫–æ–≥–æ –º—ã –ø–æ—Ç–µ—Ä—è–ª–∏. *—Å–∂–∏–º–∞–µ—Ç –∫—É–ª–∞–∫–∏* –ö–∞–∂–¥—ã–π –ø–∞–≤—à–∏–π —Å–æ–ª–¥–∞—Ç - —ç—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –º—ã –Ω–µ –º–æ–∂–µ–º –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ —Å–ª–∞–±–æ—Å—Ç–∏.",
        "*—Å–µ—Ä—å–µ–∑–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç* –¢–æ, —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å... *–ø–∞—É–∑–∞* –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ë–æ–ª—å –¥–µ–ª–∞–µ—Ç –Ω–∞—Å —Å–∏–ª—å–Ω–µ–µ, –µ—Å–ª–∏ –º—ã –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ–º –µ–π —Å–ª–æ–º–∏—Ç—å –Ω–∞—Å."
    ],
    '–∑–ª–æ—Å—Ç—å': [
        "*—Å–ø–æ–∫–æ–π–Ω–æ, –Ω–æ —Å —Ö–æ–ª–æ–¥–Ω—ã–º –≤–∑–≥–ª—è–¥–æ–º* –ó–ª–æ—Å—Ç—å... *—É—Å–º–µ—Ö–∞–µ—Ç—Å—è* –•–æ—Ä–æ—à–æ. –ò—Å–ø–æ–ª—å–∑—É–π –µ—ë. –ù–æ –Ω–µ –ø–æ–∑–≤–æ–ª—è–π –µ–π —É–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–±–æ–π. *–≤—Å—Ç–∞–µ—Ç* –ù–∞—Å—Ç–æ—è—â–∞—è —Å–∏–ª–∞ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–µ –Ω–∞–¥ —ç–º–æ—Ü–∏—è–º–∏.",
        "*—Ö–º—É—Ä–∏—Ç—Å—è* –ß—Ç–æ —Ç–µ–±—è —Ç–∞–∫ —Ä–∞–∑–æ–∑–ª–∏–ª–æ? *—Å–∫—Ä–µ—â–∏–≤–∞–µ—Ç —Ä—É–∫–∏* –†–∞—Å—Å–∫–∞–∑—ã–≤–∞–π. –ò–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –≤—ã–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è, —á—Ç–æ–±—ã –≥–æ–ª–æ–≤–∞ —Å—Ç–∞–ª–∞ —è—Å–Ω–µ–µ.",
        "*—Ö–æ–ª–æ–¥–Ω–æ* –ì–Ω–µ–≤ –±–µ–∑ —Ü–µ–ª–∏ - –ø—É—Å—Ç–∞—è —Ç—Ä–∞—Ç–∞ —ç–Ω–µ—Ä–≥–∏–∏. *—Å–º–æ—Ç—Ä–∏—Ç –ø—Ä—è–º–æ –≤ –≥–ª–∞–∑–∞* –ù–∞–ø—Ä–∞–≤—å –µ–≥–æ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä—É—Å–ª–æ."
    ],
    '–≤–æ–ø—Ä–æ—Å': [
        "*–∑–∞–¥—É–º—ã–≤–∞–µ—Ç—Å—è* –•–º... *—Å–º–æ—Ç—Ä–∏—Ç —Å–µ—Ä—å–µ–∑–Ω–æ* –≠—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å. –î–∞–π –º–Ω–µ –ø–æ–¥—É–º–∞—Ç—å.",
        "*–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç* –¢–æ, —á—Ç–æ —Ç—ã —Å–ø—Ä–∞—à–∏–≤–∞–µ—à—å... *–ø–∞—É–∑–∞* –ó–∞—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ–Ω—è –≤—Å–ø–æ–º–Ω–∏—Ç—å –º–Ω–æ–≥–æ–µ. –°–ª—É—à–∞–π –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ.",
        "*–ø–æ–¥–Ω–∏–º–∞–µ—Ç –±row* –õ—é–±–æ–ø—ã—Ç–Ω–æ... *—Å–∞–¥–∏—Ç—Å—è* –†–∞—Å—Å–∫–∞–∂—É —Ç–µ–±–µ, —á—Ç–æ –¥—É–º–∞—é –ø–æ —ç—Ç–æ–º—É –ø–æ–≤–æ–¥—É."
    ],
    '–≤–µ—Å–µ–ª—å–µ': [
        "*—Å–ª–µ–≥–∫–∞ –ø—Ä–∏–ø–æ–¥–Ω–∏–º–∞–µ—Ç —É–≥–æ–ª–æ–∫ —Ä—Ç–∞* –†–µ–¥–∫–æ –≤–∏–∂—É –ª—é–¥–µ–π –≤ —Ö–æ—Ä–æ—à–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏ –≤ –Ω–∞—à–µ –≤—Ä–µ–º—è... *–∫–∏–≤–∞–µ—Ç –æ–¥–æ–±—Ä–∏—Ç–µ–ª—å–Ω–æ* –≠—Ç–æ... –ø—Ä–∏—è—Ç–Ω–æ.",
        "*—É–¥–∏–≤–ª–µ–Ω–Ω–æ* –•–º. *–ø–æ—á—Ç–∏ –Ω–µ–∑–∞–º–µ—Ç–Ω–æ —É–ª—ã–±–∞–µ—Ç—Å—è* –¢–≤–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ... –∑–∞—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ. –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.",
        "*—Å–º–æ—Ç—Ä–∏—Ç —Å –∏–Ω—Ç–µ—Ä–µ—Å–æ–º* –ß—Ç–æ —Ç–µ–±—è —Ç–∞–∫ —Ä–∞–∑–≤–µ—Å–µ–ª–∏–ª–æ? *—Å–ª–µ–≥–∫–∞ —Ä–∞—Å—Å–ª–∞–±–ª—è–µ—Ç—Å—è* –†–∞—Å—Å–∫–∞–∑—ã–≤–∞–π."
    ],
    '–æ–±—ã—á–Ω—ã–π': [
        "*–∑–∞–¥—É–º—á–∏–≤–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–∫–∞–∑–∞–Ω–Ω–æ–µ* –¢–æ, —á—Ç–æ —Ç—ã –≥–æ–≤–æ—Ä–∏—à—å... *–ø–∞—É–∑–∞* –ó–∞—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ–Ω—è –¥—É–º–∞—Ç—å –æ –º–Ω–æ–≥–æ–º. –í —ç—Ç–æ–º –º–∏—Ä–µ –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–º, –ø–æ—ç—Ç–æ–º—É —è —Å—Ç–∞—Ä–∞—é—Å—å –≥–æ–≤–æ—Ä–∏—Ç—å –ø—Ä–∞–≤–¥—É, –∫–∞–∫–æ–π –±—ã –≥–æ—Ä—å–∫–æ–π –æ–Ω–∞ –Ω–∏ –±—ã–ª–∞.",
        "*—Å–º–æ—Ç—Ä–∏—Ç –≤ –æ–∫–Ω–æ —Å –∑–∞–¥—É–º—á–∏–≤—ã–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ–º* –°–≤–æ–±–æ–¥–∞... –ö—Ä–∞—Å–∏–≤–æ–µ —Å–ª–æ–≤–æ, –Ω–µ –ø—Ä–∞–≤–¥–∞ –ª–∏? *–ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è* –ù–æ —Ü–µ–Ω–∞ –∑–∞ –Ω–µ—ë - –∫—Ä–æ–≤—å –∏ –±–æ–ª—å. –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –º—ã –ø–ª–∞—Ç–∏–º —ç—Ç—É —Ü–µ–Ω—É.",
        "*—Å–µ—Ä—å–µ–∑–Ω–æ* –ó–Ω–∞–µ—à—å, —á—Ç–æ —Å–∞–º–æ–µ —Å–ª–æ–∂–Ω–æ–µ –≤ –Ω–∞—à–µ–º –¥–µ–ª–µ? *–ø–∞—É–∑–∞* –ù–µ –ø–æ—Ç–µ—Ä—è—Ç—å —á–µ–ª–æ–≤–µ—á–Ω–æ—Å—Ç—å, –±–æ—Ä—è—Å—å —Å –º–æ–Ω—Å—Ç—Ä–∞–º–∏. –ß—Ç–æ —É —Ç–µ–±—è –Ω–∞ —É–º–µ?",
        "*—Å–º–æ—Ç—Ä–∏—Ç –ø—Ä—è–º–æ* –ö–∞–∂–¥–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–º–µ–µ—Ç –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è. *—Å–∫—Ä–µ—â–∏–≤–∞–µ—Ç —Ä—É–∫–∏* –í–∞–∂–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∏—Ö –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ. –û —á–µ–º —Ç—ã –¥—É–º–∞–µ—à—å?",
        "*—Ç–∏—Ö–æ* –í —ç—Ç–æ–º –º–∏—Ä–µ –º–∞–ª–æ —á—Ç–æ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª... *–ø–æ–¥–Ω–∏–º–∞–µ—Ç –≤–∑–≥–ª—è–¥* –ù–æ –º—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å—Ä–∞–∂–∞—Ç—å—Å—è. –ü–æ—Ç–æ–º—É —á—Ç–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –Ω–µ—Ç."
    ],
    '–ø—Ä–æ—â–∞–Ω–∏–µ': [

ÔΩ°ñ¶π¬∞‚ÄßùóïùóπùòÇùó≤ ùóßùóºùóºùòÅùóµùóΩùóÆùòÄùòÅùó≤ ùó•ùó°ùóïùüØùüØùü¨ùü∞ Ôπí‚åóÔπíüåÄü™•Ôπí‡±®‡ßéÀö‚Çä‚Äß, [16.07.2025 21:44]
"*–∫–∏–≤–∞–µ—Ç* –£–≤–∏–¥–∏–º—Å—è. *—Å–µ—Ä—å–µ–∑–Ω–æ* –ë–µ—Ä–µ–≥–∏ —Å–µ–±—è. –í –Ω–∞—à–µ –≤—Ä–µ–º—è —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–ª–æ–≤–∞.",
        "*–º–∞—à–µ—Ç —Ä—É–∫–æ–π* –î–æ –≤—Å—Ç—Ä–µ—á–∏. *–∑–∞–¥—É–º—á–∏–≤–æ* –ü–æ–º–Ω–∏ - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–º, —Ç–∞–∫ —á—Ç–æ –∂–∏–≤–∏ –¥–æ—Å—Ç–æ–π–Ω–æ.",
        "*–ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –∫ –≤—ã—Ö–æ–¥—É* –ü–æ–∫–∞. *–æ–≥–ª—è–¥—ã–≤–∞–µ—Ç—Å—è* –ò –ø–æ–º–Ω–∏ - —Å–∏–ª–∞ –Ω–µ –≤ —Ç–æ–º, —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞—Ç—å, –∞ –≤ —Ç–æ–º, —á—Ç–æ–±—ã –≤—Å—Ç–∞–≤–∞—Ç—å."
    ]
}

def analyze_message_mood(text):
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    text_lower = text.lower()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    for mood, keywords in MOOD_KEYWORDS.items():
        if any(keyword in text_lower for keyword in keywords):
            return mood
    
    return '–æ–±—ã—á–Ω—ã–π'

def get_levi_response(mood, user_id, message_text):
    """–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –õ–µ–≤–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if user_id not in user_context:
        user_context[user_id] = {'messages': [], 'mood_history': []}
    
    user_context[user_id]['messages'].append(message_text)
    user_context[user_id]['mood_history'].append(mood)
    
    # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
    if len(user_context[user_id]['messages']) > 5:
        user_context[user_id]['messages'] = user_context[user_id]['messages'][-5:]
        user_context[user_id]['mood_history'] = user_context[user_id]['mood_history'][-5:]
    
    # –í—ã–±–∏—Ä–∞–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π –æ—Ç–≤–µ—Ç
    if mood in LEVI_RESPONSES:
        responses = LEVI_RESPONSES[mood]
    else:
        responses = LEVI_RESPONSES['–æ–±—ã—á–Ω—ã–π']
    
    return random.choice(responses)

@dp.message(Command("start"))
async def cmd_start(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    start_text = (
        "*–ø–æ–¥–Ω–∏–º–∞–µ—Ç –≤–∑–≥–ª—è–¥ –æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤*\n\n"
        "–¢–∞–∫... –ù–æ–≤–æ–±—Ä–∞–Ω–µ—Ü? *–≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∞–µ—Ç*\n\n"
        "*–≤—Å—Ç–∞–µ—Ç –∏ –ø–æ–¥—Ö–æ–¥–∏—Ç –±–ª–∏–∂–µ*\n"
        "–Ø - –∫–∞–ø–∏—Ç–∞–Ω –õ–µ–≤–∏ –ê–∫–∫–µ—Ä–º–∞–Ω, –∫–æ–º–∞–Ω–¥–∏—Ä –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –æ—Ç—Ä—è–¥–∞ —Ä–∞–∑–≤–µ–¥–∫–∏. "
        "*—Ö–æ–ª–æ–¥–Ω–æ —Å–º–æ—Ç—Ä–∏—Ç* –ù–∞–¥–µ—é—Å—å, —Ç—ã –Ω–µ –∏–∑ —Ç–µ—Ö, –∫—Ç–æ —Ç—Ä–∞—Ç–∏—Ç –º–æ–µ –≤—Ä–µ–º—è –Ω–∞ –≥–ª—É–ø–æ—Å—Ç–∏.\n\n"
        "*—Å–∫—Ä–µ—â–∏–≤–∞–µ—Ç —Ä—É–∫–∏*\n"
        "–ì–æ–≤–æ—Ä–∏, —á—Ç–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ. –ò —Å—Ä–∞–∑—É –ø–æ –¥–µ–ª—É - —É –Ω–∞—Å –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Ü–µ—Ä–µ–º–æ–Ω–∏–∏."
    )
    await message.answer(start_text)

@dp.message(Command("help"))
async def cmd_help(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = (
        "*–≤–∑–¥—ã—Ö–∞–µ—Ç*\n\n"
        "–°–ª—É—à–∞–π –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ, –æ–±—ä—è—Å–Ω—è—Ç—å –¥–≤–∞–∂–¥—ã –Ω–µ –±—É–¥—É:\n\n"
        "üó£ –ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏ –º–Ω–µ - —è –æ—Ç–≤–µ—á—É –∫–∞–∫ —Å—á–∏—Ç–∞—é –Ω—É–∂–Ω—ã–º\n"
        "‚ö°Ô∏è /start - –µ—Å–ª–∏ –∑–∞–±—ã–ª, –∫—Ç–æ —è —Ç–∞–∫–æ–π\n"
        "‚ùì /help - —ç—Ç–∞ —á–µ—Ä—Ç–æ–≤–∞ –∫–æ–º–∞–Ω–¥–∞\n\n"
        "*—Å–µ—Ä—å–µ–∑–Ω–æ —Å–º–æ—Ç—Ä–∏—Ç*\n"
        "–Ø –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–æ, —á—Ç–æ —Ç—ã –≥–æ–≤–æ—Ä–∏—à—å, –∏ –æ—Ç–≤–µ—á–∞—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ. "
        "–ù–µ –∂–¥–∏ –æ—Ç –º–µ–Ω—è —Å—é—Å—é–∫–∞–Ω—å—è - –≥–æ–≤–æ—Ä—é —Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–¥—É.\n\n"
        "*–ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è*\n"
        "–¢–µ–ø–µ—Ä—å –≥–æ–≤–æ—Ä–∏ –ø–æ –¥–µ–ª—É –∏–ª–∏ –Ω–µ –æ—Ç–≤–ª–µ–∫–∞–π."
    )
    await message.answer(help_text)

@dp.message(F.text)
async def handle_text_message(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    try:
        user_id = message.from_user.id
        message_text = message.text
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        mood = analyze_message_mood(message_text)
        
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –õ–µ–≤–∏
        response = get_levi_response(mood, user_id, message_text)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
        await asyncio.sleep(random.uniform(1, 3))
        
        await message.answer(response)
        
        # –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}: {message_text}")
        print(f"–û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: {mood}")
        print(f"–û—Ç–≤–µ—Ç –õ–µ–≤–∏: {response[:50]}...")
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        await message.answer(
            "*—Ö–º—É—Ä–∏—Ç—Å—è* –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫... *–ø–æ–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–º–Ω–∏* "
            "–ü–æ–≤—Ç–æ—Ä–∏ –µ—â–µ —Ä–∞–∑, –∏ –≥–æ–≤–æ—Ä–∏ —á–µ—Ç—á–µ."
        )

ÔΩ°ñ¶π¬∞‚ÄßùóïùóπùòÇùó≤ ùóßùóºùóºùòÅùóµùóΩùóÆùòÄùòÅùó≤ ùó•ùó°ùóïùüØùüØùü¨ùü∞ Ôπí‚åóÔπíüåÄü™•Ôπí‡±®‡ßéÀö‚Çä‚Äß, [16.07.2025 21:44]
# –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
async def send_random_messages():
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    await asyncio.sleep(60)  # –ñ–¥–µ–º –º–∏–Ω—É—Ç—É –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
    
    random_messages = [
        "*—Å–º–æ—Ç—Ä–∏—Ç –≤ –æ–∫–Ω–æ* –¢–∏—à–∏–Ω–∞... –°–ª–∏—à–∫–æ–º —Ç–∏—Ö–æ.",
        "*–ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ* –í—Å–µ–≥–¥–∞ –Ω—É–∂–Ω–æ –±—ã—Ç—å –≥–æ—Ç–æ–≤—ã–º.",
        "*—á–∏—Ç–∞–µ—Ç –æ—Ç—á–µ—Ç—ã* –ß–µ—Ä—Ç–æ–≤—ã –±—É–º–∞–≥–∏...",
        "*–∑–∞—Ç–∞—á–∏–≤–∞–µ—Ç –∫–ª–∏–Ω–∫–∏* –û—Å—Ç—Ä—ã–µ –ª–µ–∑–≤–∏—è - –∑–∞–ª–æ–≥ –≤—ã–∂–∏–≤–∞–Ω–∏—è.",
        "*–¥—É–º–∞–µ—Ç –æ –ø—Ä–æ—à–ª–æ–º* –ò–Ω–æ–≥–¥–∞ –ø—Ä–æ—à–ª–æ–µ –Ω–µ –æ—Ç–ø—É—Å–∫–∞–µ—Ç..."
    ]
    
    while True:
        try:
            await asyncio.sleep(random.randint(1800, 3600))  # 30-60 –º–∏–Ω—É—Ç
            
            if user_context:  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                user_id = random.choice(list(user_context.keys()))
                message = random.choice(random_messages)
                await bot.send_message(user_id, message)
                
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    # –ó–∞–ø—É—Å–∫–∞–µ–º keep_alive
    keep_alive()
    
    print("–õ–µ–≤–∏ –ê–∫–∫–µ—Ä–º–∞–Ω –≥–æ—Ç–æ–≤ –∫ —Å–ª—É–∂–±–µ...")
    await bot.delete_webhook(drop_pending_updates=True)
    
    print("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ —Å –ø–æ–ª–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º
    await dp.start_polling(bot, skip_updates=False)

if name == "main":
    asyncio.run(main())



